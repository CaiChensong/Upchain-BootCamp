### 生成 Gas Report 的命令

```shell
# 优化前
forge test --match-contract NFTMarketTest -vvv --gas-report

# 优化后
forge test --match-contract NFTMarketBetterGasTest -vvv --gas-report
```

### 优化前的 Gas Report

```shell
Ran 7 tests for test/W2D2/NFTMarket.t.sol:NFTMarketTest
[PASS] test_BuyMultipleNFTs() (gas: 603645)
[PASS] test_BuyNFT() (gas: 332577)
[PASS] test_BuyNFTWithCallback() (gas: 309639)
[PASS] test_Constructor() (gas: 23991)
[PASS] test_Events() (gas: 287731)
[PASS] test_ListMultipleNFTs() (gas: 368005)
[PASS] test_ListNFT() (gas: 198406)
Suite result: ok. 7 passed; 0 failed; 0 skipped; finished in 15.47ms (8.91ms CPU time)

Ran 9 tests for test/W2D5/NFTMarket.t.sol:NFTMarketTest
[PASS] test_buy_fail_repeat() (gas: 201070)
[PASS] test_buy_fail_self_buy() (gas: 145349)
[PASS] test_buy_fail_token_not_enough() (gas: 138857)
[PASS] test_buy_success() (gas: 222411)
[PASS] test_buy_success_token_more_than_price() (gas: 177620)
[PASS] test_fuzz_list_and_buy(uint96,uint8) (runs: 257, μ: 181136, ~: 181390)
[PASS] test_list_fail_not_owner() (gas: 78361)
[PASS] test_list_success() (gas: 142267)
[PASS] test_market_never_hold_token() (gas: 175206)
Suite result: ok. 9 passed; 0 failed; 0 skipped; finished in 59.73ms (54.17ms CPU time)

╭---------------------------------------------+-----------------+--------+--------+--------+---------╮
| src/W2D2/ERC20Hook.sol:ERC20Extend Contract |                 |        |        |        |         |
+====================================================================================================+
| Deployment Cost                             | Deployment Size |        |        |        |         |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| 1162496                                     | 6096            |        |        |        |         |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
|                                             |                 |        |        |        |         |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| Function Name                               | Min             | Avg    | Median | Max    | # Calls |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| approve                                     | 46722           | 46722  | 46722  | 46722  | 4       |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| balanceOf                                   | 2829            | 2829   | 2829   | 2829   | 7       |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| transfer                                    | 52136           | 52136  | 52136  | 52136  | 21      |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| transferWithCallback                        | 106104          | 106104 | 106104 | 106104 | 1       |
╰---------------------------------------------+-----------------+--------+--------+--------+---------╯

╭-----------------------------------------+-----------------+-------+--------+-------+---------╮
| src/W2D2/ERC721.sol:BaseERC721 Contract |                 |       |        |       |         |
+==============================================================================================+
| Deployment Cost                         | Deployment Size |       |        |       |         |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| 2194371                                 | 11156           |       |        |       |         |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
|                                         |                 |       |        |       |         |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| Function Name                           | Min             | Avg   | Median | Max   | # Calls |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| approve                                 | 49017           | 49017 | 49017  | 49017 | 8       |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| mint                                    | 68815           | 68815 | 68815  | 68815 | 14      |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| ownerOf                                 | 2875            | 2875  | 2875   | 2875  | 22      |
╰-----------------------------------------+-----------------+-------+--------+-------+---------╯

╭---------------------------------------------+-----------------+--------+--------+--------+---------╮
| src/W2D2/NFTMarket.sol:MyNFTMarket Contract |                 |        |        |        |         |
+====================================================================================================+
| Deployment Cost                             | Deployment Size |        |        |        |         |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| 923845                                      | 4217            |        |        |        |         |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
|                                             |                 |        |        |        |         |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| Function Name                               | Min             | Avg    | Median | Max    | # Calls |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| _nftToken                                   | 2575            | 2575   | 2575   | 2575   | 1       |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| _token                                      | 2573            | 2573   | 2573   | 2573   | 1       |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| buyNFT                                      | 74024           | 79325  | 74024  | 95230  | 4       |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| list                                        | 94122           | 106947 | 111222 | 111222 | 8       |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| prices                                      | 2754            | 2754   | 2754   | 2754   | 5       |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| sellers                                     | 2849            | 2849   | 2849   | 2849   | 5       |
╰---------------------------------------------+-----------------+--------+--------+--------+---------╯

╭-------------------------------------------+-----------------+-------+--------+-------+---------╮
| src/W2D5/NFTMarket.sol:MockERC20 Contract |                 |       |        |       |         |
+================================================================================================+
| Deployment Cost                           | Deployment Size |       |        |       |         |
|-------------------------------------------+-----------------+-------+--------+-------+---------|
| 925027                                    | 5217            |       |        |       |         |
|-------------------------------------------+-----------------+-------+--------+-------+---------|
|                                           |                 |       |        |       |         |
|-------------------------------------------+-----------------+-------+--------+-------+---------|
| Function Name                             | Min             | Avg   | Median | Max   | # Calls |
|-------------------------------------------+-----------------+-------+--------+-------+---------|
| approve                                   | 47240           | 47240 | 47240  | 47240 | 27      |
|-------------------------------------------+-----------------+-------+--------+-------+---------|
| balanceOf                                 | 2850            | 2850  | 2850   | 2850  | 3       |
|-------------------------------------------+-----------------+-------+--------+-------+---------|
| mint                                      | 51619           | 57319 | 51619  | 68719 | 27      |
╰-------------------------------------------+-----------------+-------+--------+-------+---------╯

╭--------------------------------------------+-----------------+-------+--------+-------+---------╮
| src/W2D5/NFTMarket.sol:MockERC721 Contract |                 |       |        |       |         |
+=================================================================================================+
| Deployment Cost                            | Deployment Size |       |        |       |         |
|--------------------------------------------+-----------------+-------+--------+-------+---------|
| 1732474                                    | 8968            |       |        |       |         |
|--------------------------------------------+-----------------+-------+--------+-------+---------|
|                                            |                 |       |        |       |         |
|--------------------------------------------+-----------------+-------+--------+-------+---------|
| Function Name                              | Min             | Avg   | Median | Max   | # Calls |
|--------------------------------------------+-----------------+-------+--------+-------+---------|
| approve                                    | 49011           | 49011 | 49011  | 49011 | 27      |
|--------------------------------------------+-----------------+-------+--------+-------+---------|
| ownerOf                                    | 3071            | 3071  | 3071   | 3071  | 521     |
|--------------------------------------------+-----------------+-------+--------+-------+---------|
| safeMint                                   | 69269           | 69269 | 69269  | 69269 | 27      |
╰--------------------------------------------+-----------------+-------+--------+-------+---------╯

╭-------------------------------------------+-----------------+--------+--------+--------+---------╮
| src/W2D5/NFTMarket.sol:NFTMarket Contract |                 |        |        |        |         |
+==================================================================================================+
| Deployment Cost                           | Deployment Size |        |        |        |         |
|-------------------------------------------+-----------------+--------+--------+--------+---------|
| 793806                                    | 3863            |        |        |        |         |
|-------------------------------------------+-----------------+--------+--------+--------+---------|
|                                           |                 |        |        |        |         |
|-------------------------------------------+-----------------+--------+--------+--------+---------|
| Function Name                             | Min             | Avg    | Median | Max    | # Calls |
|-------------------------------------------+-----------------+--------+--------+--------+---------|
| buy                                       | 24512           | 66265  | 66698  | 66698  | 263     |
|-------------------------------------------+-----------------+--------+--------+--------+---------|
| list                                      | 69792           | 108889 | 109046 | 109046 | 264     |
|-------------------------------------------+-----------------+--------+--------+--------+---------|
| prices                                    | 2798            | 2798   | 2798   | 2798   | 2       |
|-------------------------------------------+-----------------+--------+--------+--------+---------|
| sellers                                   | 2827            | 2827   | 2827   | 2827   | 2       |
╰-------------------------------------------+-----------------+--------+--------+--------+---------╯


Ran 2 test suites in 87.77ms (75.20ms CPU time): 16 tests passed, 0 failed, 0 skipped (16 total tests)
```

### 优化后的 Gas Report

```shell
Ran 7 tests for test/W4D3/NFTMarketBetterGas.t.sol:NFTMarketBetterGasTest
[PASS] test_BuyMultipleNFTs() (gas: 592527)
[PASS] test_BuyNFT() (gas: 322280)
[PASS] test_BuyNFTWithCallback() (gas: 299248)
[PASS] test_Constructor() (gas: 19655)
[PASS] test_Events() (gas: 283013)
[PASS] test_ListMultipleNFTs() (gas: 349957)
[PASS] test_ListNFT() (gas: 190632)
Suite result: ok. 7 passed; 0 failed; 0 skipped; finished in 7.24ms (8.96ms CPU time)

╭---------------------------------------------+-----------------+--------+--------+--------+---------╮
| src/W2D2/ERC20Hook.sol:ERC20Extend Contract |                 |        |        |        |         |
+====================================================================================================+
| Deployment Cost                             | Deployment Size |        |        |        |         |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| 1162496                                     | 6096            |        |        |        |         |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
|                                             |                 |        |        |        |         |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| Function Name                               | Min             | Avg    | Median | Max    | # Calls |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| approve                                     | 46722           | 46722  | 46722  | 46722  | 4       |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| balanceOf                                   | 2829            | 2829   | 2829   | 2829   | 7       |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| transfer                                    | 52136           | 52136  | 52136  | 52136  | 21      |
|---------------------------------------------+-----------------+--------+--------+--------+---------|
| transferWithCallback                        | 102615          | 102615 | 102615 | 102615 | 1       |
╰---------------------------------------------+-----------------+--------+--------+--------+---------╯

╭-----------------------------------------+-----------------+-------+--------+-------+---------╮
| src/W2D2/ERC721.sol:BaseERC721 Contract |                 |       |        |       |         |
+==============================================================================================+
| Deployment Cost                         | Deployment Size |       |        |       |         |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| 2194371                                 | 11156           |       |        |       |         |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
|                                         |                 |       |        |       |         |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| Function Name                           | Min             | Avg   | Median | Max   | # Calls |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| approve                                 | 49017           | 49017 | 49017  | 49017 | 8       |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| mint                                    | 68815           | 68815 | 68815  | 68815 | 14      |
|-----------------------------------------+-----------------+-------+--------+-------+---------|
| ownerOf                                 | 2875            | 2875  | 2875   | 2875  | 22      |
╰-----------------------------------------+-----------------+-------+--------+-------+---------╯

╭-------------------------------------------------------------+-----------------+--------+--------+--------+---------╮
| src/W4D3/NFTMarketBetterGas.sol:NFTMarketBetterGas Contract |                 |        |        |        |         |
+====================================================================================================================+
| Deployment Cost                                             | Deployment Size |        |        |        |         |
|-------------------------------------------------------------+-----------------+--------+--------+--------+---------|
| 985145                                                      | 4763            |        |        |        |         |
|-------------------------------------------------------------+-----------------+--------+--------+--------+---------|
|                                                             |                 |        |        |        |         |
|-------------------------------------------------------------+-----------------+--------+--------+--------+---------|
| Function Name                                               | Min             | Avg    | Median | Max    | # Calls |
|-------------------------------------------------------------+-----------------+--------+--------+--------+---------|
| _nftToken                                                   | 373             | 373    | 373    | 373    | 1       |
|-------------------------------------------------------------+-----------------+--------+--------+--------+---------|
| _token                                                      | 439             | 439    | 439    | 439    | 1       |
|-------------------------------------------------------------+-----------------+--------+--------+--------+---------|
| buyNFT                                                      | 70660           | 75751  | 70660  | 91025  | 4       |
|-------------------------------------------------------------+-----------------+--------+--------+--------+---------|
| list                                                        | 91927           | 104752 | 109027 | 109027 | 8       |
|-------------------------------------------------------------+-----------------+--------+--------+--------+---------|
| listings                                                    | 5145            | 5145   | 5145   | 5145   | 5       |
╰-------------------------------------------------------------+-----------------+--------+--------+--------+---------╯


Ran 1 test suite in 13.21ms (7.24ms CPU time): 7 tests passed, 0 failed, 0 skipped (7 total tests)
```

### 优化效果分析

通过对比优化前后的 Gas Report，可以得出以下结论：

#### 1. **测试用例 Gas 消耗对比**

| 测试用例                | 优化前 (gas) | 优化后 (gas) | 节省 (gas) | 节省比例 |
| ----------------------- | ------------ | ------------ | ---------- | -------- |
| test_BuyMultipleNFTs    | 603,645      | 592,527      | 11,118     | 1.8%     |
| test_BuyNFT             | 332,577      | 322,280      | 10,297     | 3.1%     |
| test_BuyNFTWithCallback | 309,639      | 299,248      | 10,391     | 3.4%     |
| test_Constructor        | 23,991       | 19,655       | 4,336      | 18.1%    |
| test_Events             | 287,731      | 283,013      | 4,718      | 1.6%     |
| test_ListMultipleNFTs   | 368,005      | 349,957      | 18,048     | 4.9%     |
| test_ListNFT            | 198,406      | 190,632      | 7,774      | 3.9%     |

#### 2. **合约部署成本对比**

| 合约        | 优化前部署成本 | 优化后部署成本 | 节省    | 节省比例 |
| ----------- | -------------- | -------------- | ------- | -------- |
| MyNFTMarket | 923,845        | 985,145        | -61,300 | -6.6%    |

#### 3. **函数调用 Gas 消耗对比**

| 函数   | 优化前 (gas)   | 优化后 (gas)   | 节省 (gas)  | 节省比例 |
| ------ | -------------- | -------------- | ----------- | -------- |
| buyNFT | 74,024-95,230  | 70,660-91,025  | 3,364-4,205 | 4.5%     |
| list   | 94,122-111,222 | 91,927-109,027 | 2,195-2,195 | 2.0%     |

#### 4. **存储读取优化对比**

| 操作            | 优化前 (gas) | 优化后 (gas) | 节省 (gas) | 节省比例 |
| --------------- | ------------ | ------------ | ---------- | -------- |
| \_nftToken 读取 | 2,575        | 373          | 2,202      | 85.5%    |
| \_token 读取    | 2,573        | 439          | 2,134      | 83.0%    |
| listings 读取   | -            | 5,145        | -          | -        |

#### 5. **优化效果总结**

**实际优化效果：**

- **总体节省**：所有测试用例总共节省了 66,682 gas，平均节省约 2.8%
- **最大节省**：test_Constructor 节省了 4,336 gas（18.1%）
- **最小节省**：test_Events 节省了 4,718 gas（1.6%）
- **平均节省**：每个测试用例平均节省约 9,526 gas

**主要优化点分析：**

1. **immutable 变量优化**：

   - \_nftToken 读取从 2,575 gas 降至 373 gas（节省 85.5%）
   - \_token 读取从 2,573 gas 降至 439 gas（节省 83.0%）
   - 构造函数节省 4,336 gas（18.1%）

2. **结构体打包优化**：

   - 将 prices 和 sellers 合并为 listings 结构体
   - 减少了存储槽使用，但增加了结构体读取成本
   - 在多次操作时体现更明显的节省

3. **函数调用优化**：
   - buyNFT 函数节省 3,364-4,205 gas（4.5%）
   - list 函数节省 2,195 gas（2.0%）

**部署成本分析：**

- 优化后部署成本增加了 61,300 gas（6.6%）
- 这是因为 immutable 变量需要在字节码中硬编码，增加了合约大小
- 但运行时的 gas 节省会抵消这部分成本

**结论：**

1. **运行时优化效果显著**：immutable 变量读取节省了 83-85% 的 gas
2. **函数调用优化明显**：主要函数节省了 2-4.5% 的 gas
3. **部署成本略有增加**：但被运行时的节省所抵消
4. **长期效益更好**：在频繁调用时，immutable 变量的节省会累积产生更大的效益

**实际应用价值：**

- 在频繁读取合约地址的场景下，immutable 优化效果非常显著
- 结构体打包在大量数据操作时会产生更大的节省
- 总体而言，优化后的合约在运行时效率更高，适合高频交易场景
